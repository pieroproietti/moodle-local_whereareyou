{"version":3,"file":"modal.min.js","sources":["../src/modal.js"],"sourcesContent":["define([\n    'core/templates',\n    'core/str', \n    'core/notification'\n], function(Templates, Str, Notification) {\n    'use strict';\n\n    class WhereAreYouModal {\n        \n        constructor() {\n            this.config = null;\n            this.modalElement = null;\n            this.isLoading = false;\n        }\n\n        async init() {\n            try {\n                this.config = window.M.cfg.whereareyou_config || {};\n\n                // AGGIUNGI QUESTA RIGA DI DEBUG\n                console.log('Debug - Config ricevuta:', this.config);\n                console.log('Debug - Tutte le chiavi config:', Object.keys(this.config));\n                console.log('Debug - Ajax URL:', this.config.ajax_url);\n                console.log('Debug - Logout URL:', this.config.logout_url);\n                console.log('Debug - window.M.cfg completo:', window.M.cfg);\n        \n                await this.loadLanguageStrings();\n                await this.renderModal();\n                this.attachEventListeners();\n                console.log('WhereAreYou Modal inizializzata');\n            } catch (error) {\n                console.error('Errore inizializzazione WhereAreYou Modal:', error);\n                Notification.exception(error);\n            }\n        }\n\n        async loadLanguageStrings() {\n            const strings = await Str.get_strings([\n                {key: 'modal_title', component: 'local_whereareyou'},\n                {key: 'department', component: 'local_whereareyou'},\n                {key: 'position', component: 'local_whereareyou'},\n                {key: 'save', component: 'local_whereareyou'},\n                {key: 'logout', component: 'local_whereareyou'},\n                {key: 'department_pizzicaroli', component: 'local_whereareyou'},\n                {key: 'department_gesmundo', component: 'local_whereareyou'},\n                {key: 'department_remote', component: 'local_whereareyou'},\n                {key: 'position_preside', component: 'local_whereareyou'},\n                {key: 'position_teacher', component: 'local_whereareyou'},\n                {key: 'position_student', component: 'local_whereareyou'}\n            ]);\n\n            this.strings = {\n                modal_title: strings[0],\n                department_label: strings[1],\n                position_label: strings[2],\n                save_label: strings[3],\n                logout_label: strings[4],\n                departments: {\n                    pizzicaroli: strings[5],\n                    gesmundo: strings[6],\n                    remote: strings[7]\n                },\n                positions: {\n                    preside: strings[8],\n                    teacher: strings[9],\n                    student: strings[10]\n                }\n            };\n        }\n\n        prepareTemplateData() {\n            const currentDept = this.config.current_department || '';\n            const currentPos = this.config.current_position || '';\n\n            return {\n                modal_title: this.strings.modal_title,\n                department_label: this.strings.department_label,\n                position_label: this.strings.position_label,\n                save_label: this.strings.save_label,\n                logout_label: this.strings.logout_label,\n                departments: [\n                    {\n                        value: 'Pizzicaroli',\n                        label: this.strings.departments.pizzicaroli,\n                        selected: currentDept === 'Pizzicaroli'\n                    },\n                    {\n                        value: 'Gesmundo',\n                        label: this.strings.departments.gesmundo,\n                        selected: currentDept === 'Gesmundo'\n                    },\n                    {\n                        value: 'Remoto',\n                        label: this.strings.departments.remote,\n                        selected: currentDept === 'Remoto'\n                    }\n                ],\n                positions: [\n                    {\n                        value: 'Preside',\n                        label: this.strings.positions.preside,\n                        selected: currentPos === 'Preside'\n                    },\n                    {\n                        value: 'Insegnante',\n                        label: this.strings.positions.teacher,\n                        selected: currentPos === 'Insegnante'\n                    },\n                    {\n                        value: 'Alunno',\n                        label: this.strings.positions.student,\n                        selected: currentPos === 'Alunno'\n                    }\n                ]\n            };\n        }\n\n        async renderModal() {\n            try {\n                const templateData = this.prepareTemplateData();\n                const html = await Templates.render('local_whereareyou/modal', templateData);\n                document.body.insertAdjacentHTML('beforeend', html);\n                this.modalElement = document.getElementById('whereareyou-modal-backdrop');\n                this.showModal();\n            } catch (error) {\n                console.error('Errore rendering modal:', error);\n                throw error;\n            }\n        }\n\n        showModal() {\n            if (this.modalElement) {\n                this.modalElement.style.display = 'flex';\n                this.modalElement.offsetHeight;\n                this.modalElement.classList.add('show');\n                \n                const firstSelect = this.modalElement.querySelector('#whereareyou-department');\n                if (firstSelect) {\n                    firstSelect.focus();\n                }\n            }\n        }\n\n        hideModal() {\n            if (this.modalElement) {\n                this.modalElement.style.display = 'none';\n                this.modalElement.remove();\n                this.modalElement = null;\n            }\n        }\n\n        attachEventListeners() {\n            if (!this.modalElement) return;\n\n            const saveBtn = this.modalElement.querySelector('#whereareyou-save-btn');\n            if (saveBtn) {\n                saveBtn.addEventListener('click', (e) => {\n                    e.preventDefault();\n                    this.handleSave();\n                });\n            }\n\n            const logoutBtn = this.modalElement.querySelector('#whereareyou-logout-btn');\n            if (logoutBtn) {\n                logoutBtn.addEventListener('click', (e) => {\n                    e.preventDefault();\n                    this.handleLogout();\n                });\n            }\n\n            const form = this.modalElement.querySelector('#whereareyou-form');\n            if (form) {\n                form.addEventListener('submit', (e) => {\n                    e.preventDefault();\n                    this.handleSave();\n                });\n            }\n        }\n\n        async handleSave() {\n            if (this.isLoading) return;\n\n            try {\n                const department = this.modalElement.querySelector('#whereareyou-department').value;\n                const position = this.modalElement.querySelector('#whereareyou-position').value;\n\n                if (!department || !position) {\n                    await Notification.alert('Attenzione', 'Seleziona sia il dipartimento che la posizione.');\n                    return;\n                }\n\n                this.setLoading(true);\n                const success = await this.saveData(department, position);\n\n                if (success) {\n                    this.hideModal();\n                    await Notification.alert('Successo', 'Dati salvati correttamente!');\n                } else {\n                    throw new Error('Salvataggio fallito');\n                }\n\n            } catch (error) {\n                console.error('Errore salvataggio:', error);\n                await Notification.exception(error);\n            } finally {\n                this.setLoading(false);\n            }\n        }\n\n        async saveData(department, position) {\n            try {\n                const Ajax = await import('core/ajax');\n                \n                const response = await Ajax.call([{\n                    methodname: 'local_whereareyou_save_data',\n                    args: {\n                        department: department,\n                        position: position\n                    }\n                }]);\n                \n                if (response[0] && response[0].success) {\n                    console.log('Data saved via Web Service:', response[0]);\n                    return true;\n                } else {\n                    throw new Error(response[0]?.message || 'Save failed');\n                }\n                \n            } catch (error) {\n                console.error('Web Service Error:', error);\n                return await this.saveDataFallback(department, position);\n            }\n        }\n\n        async saveDataFallback(department, position) {\n            try {\n                const formData = new FormData();\n                formData.append('action', 'save');\n                formData.append('department', department);\n                formData.append('position', position);\n                formData.append('sesskey', window.M.cfg.sesskey);\n\n                const response = await fetch(this.config.ajax_url, {\n                    method: 'POST',\n                    body: formData,\n                    credentials: 'same-origin'\n                });\n\n                if (!response.ok) {\n                    throw new Error(`HTTP error! status: ${response.status}`);\n                }\n\n                const data = await response.json();\n                \n                if (data.success) {\n                    console.log('Data saved via fallback AJAX');\n                    return true;\n                } else {\n                    throw new Error(data.error || 'Errore sconosciuto');\n                }\n\n            } catch (error) {\n                console.error('Fallback AJAX Error:', error);\n                throw error;\n            }\n        }\n\n        handleLogout() {\n            if (this.isLoading) return;\n            \n            if (this.config.logout_url) {\n                window.location.href = this.config.logout_url;\n            } else {\n                console.error('URL logout non configurato');\n            }\n        }\n\n        setLoading(loading) {\n            this.isLoading = loading;\n            \n            if (!this.modalElement) return;\n\n            const loadingEl = this.modalElement.querySelector('#whereareyou-loading');\n            const saveBtn = this.modalElement.querySelector('#whereareyou-save-btn');\n            const logoutBtn = this.modalElement.querySelector('#whereareyou-logout-btn');\n\n            if (loading) {\n                if (loadingEl) loadingEl.style.display = 'flex';\n                if (saveBtn) saveBtn.disabled = true;\n                if (logoutBtn) logoutBtn.disabled = true;\n            } else {\n                if (loadingEl) loadingEl.style.display = 'none';\n                if (saveBtn) saveBtn.disabled = false;\n                if (logoutBtn) logoutBtn.disabled = false;\n            }\n        }\n    }\n\n    let modalInstance = null;\n\n    return {\n        init: function() {\n            if (!modalInstance) {\n                modalInstance = new WhereAreYouModal();\n            }\n            modalInstance.init();\n        },\n\n        showModal: function() {\n            if (!modalInstance) {\n                modalInstance = new WhereAreYouModal();\n            }\n            modalInstance.init();\n        }\n    };\n});"],"names":["define","Templates","Str","Notification","WhereAreYouModal","constructor","this","config","modalElement","isLoading","init","window","M","cfg","whereareyou_config","console","log","Object","keys","ajax_url","logout_url","loadLanguageStrings","renderModal","attachEventListeners","error","exception","strings","get_strings","key","component","modal_title","department_label","position_label","save_label","logout_label","departments","pizzicaroli","gesmundo","remote","positions","preside","teacher","student","prepareTemplateData","currentDept","current_department","currentPos","current_position","value","label","selected","templateData","html","render","document","body","insertAdjacentHTML","getElementById","showModal","style","display","offsetHeight","classList","add","firstSelect","querySelector","focus","hideModal","remove","saveBtn","addEventListener","e","preventDefault","handleSave","logoutBtn","handleLogout","form","department","position","alert","setLoading","saveData","Error","Ajax","_systemImportTransformerGlobalIdentifier","amd","Promise","resolve","reject","require","module","exports","loader","response","call","methodname","args","success","message","saveDataFallback","formData","FormData","append","sesskey","fetch","method","credentials","ok","status","data","json","location","href","loading","loadingEl","disabled","modalInstance"],"mappings":"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"}